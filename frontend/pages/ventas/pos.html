<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta - Paints</title>
    <link rel="stylesheet" href="/frontend/assets/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .pos-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
            height: calc(100vh - 140px);
        }
        
        .product-search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .product-search-item:hover {
            background: var(--primary-50);
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }
        
        .product-details {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .product-stock {
            font-size: 0.75rem;
            color: var(--success-green);
        }
        
        .product-stock.low {
            color: var(--warning-yellow);
        }
        
        .product-stock.out {
            color: var(--error-red);
        }
        
        .product-price-section {
            text-align: right;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }
        
        .invoice-product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            transition: background-color 0.2s;
        }
        
        .invoice-product-item:hover {
            background: var(--gray-50);
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .quantity-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }
        
        .quantity-input {
            width: 60px;
            padding: 0.25rem;
            text-align: center;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
        }
        
        .payment-method {
            flex: 1;
            transition: all 0.2s;
            margin: 0 0.25rem;
        }
        
        .payment-method.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        
        .payment-details {
            margin-top: 1rem;
        }
        
        .invoice-summary {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }
        
        .summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .summary-line.total {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--primary-blue);
            border-top: 1px solid var(--gray-300);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .search-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        
        .filter-btn:hover:not(.active) {
            background: var(--gray-100);
        }
        
        .barcode-scanner {
            position: relative;
        }
        
        .scanner-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--gray-400);
            transition: color 0.2s;
        }
        
        .scanner-icon:hover {
            color: var(--primary-blue);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .success-content {
            background: white;
            padding: 3rem;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 400px;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--success-green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1rem;
        }
        
        @media (max-width: 768px) {
            .pos-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .search-filters {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/frontend/pages/admin/dashboard.html" class="logo">
                <span class="logo-icon">
                    <i class="fas fa-paint-brush"></i>
                </span>
                Paints
            </a>
            <div class="user-menu">
                <div class="user-info">
                    <span class="user-avatar" id="userAvatar">U</span>
                    <div>
                        <div style="font-weight: 500;" id="userName">Cargando...</div>
                        <div style="font-size: 0.875rem; color: var(--gray-500);" id="userRole">-</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title" id="sidebarRole">Usuario</h2>
                <p class="sidebar-subtitle" id="sidebarEmail">usuario@paints.com</p>
            </div>
            <nav>
                <ul class="sidebar-nav" id="sidebarNav">
                    <!-- Se llena dinámicamente según el rol -->
                </ul>
            </nav>
            <button class="logout-btn" onclick="auth.logout()">
                <i class="fas fa-sign-out-alt"></i>
                Cerrar Sesión
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="pos-layout">
                <!-- Panel de búsqueda de productos -->
                <div class="card" style="display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h2><i class="fas fa-cash-register"></i> Punto de Venta</h2>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">
                            Sucursal Central - Cajero: <span id="cashierName">Cargando...</span>
                        </div>
                    </div>
                    
                    <div class="card-content" style="flex: 1; overflow: hidden;">
                        <!-- Búsqueda y filtros -->
                        <div class="form-group">
                            <label class="form-label">Buscar Producto</label>
                            <div class="barcode-scanner">
                                <input type="text" placeholder="Nombre, código, código de barras..." 
                                       class="form-input" id="productSearchInput">
                                <i class="fas fa-barcode scanner-icon" onclick="scanBarcode()" title="Escanear código de barras"></i>
                            </div>
                        </div>
                        
                        <div class="search-filters">
                            <button class="filter-btn active" data-category="all" onclick="filterProducts('all')">
                                <i class="fas fa-th"></i> Todos
                            </button>
                            <button class="filter-btn" data-category="pinturas" onclick="filterProducts('pinturas')">
                                <i class="fas fa-paint-brush"></i> Pinturas
                            </button>
                            <button class="filter-btn" data-category="accesorios" onclick="filterProducts('accesorios')">
                                <i class="fas fa-tools"></i> Accesorios
                            </button>
                            <button class="filter-btn" data-category="solventes" onclick="filterProducts('solventes')">
                                <i class="fas fa-tint"></i> Solventes
                            </button>
                            <button class="filter-btn" data-category="barnices" onclick="filterProducts('barnices')">
                                <i class="fas fa-spray-can"></i> Barnices
                            </button>
                        </div>
                        
                        <div id="productSearchResults" style="flex: 1; overflow-y: auto; max-height: 500px;">
                            <div style="padding: 2rem; text-align: center; color: var(--gray-500);">
                                <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                <p>Escriba para buscar productos</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de factura -->
                <div class="card" style="display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3><i class="fas fa-receipt"></i> Nueva Factura</h3>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">
                            Serie: A &nbsp;&nbsp; Correlativo: <span id="nextCorrelativo">001</span>
                        </div>
                    </div>
                    
                    <div class="card-content" style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Datos del Cliente -->
                        <div style="margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="consumidorFinal" checked> 
                                    <span>Consumidor Final</span>
                                </label>
                            </div>
                            
                            <div id="clientDataSection" class="hidden">
                                <div class="form-group">
                                    <label class="form-label">NIT</label>
                                    <input type="text" class="form-input" id="clientNit" placeholder="12345678-9">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-input" id="clientName" placeholder="Nombre completo">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" class="form-input" id="clientAddress" placeholder="Dirección">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productos en la factura -->
                        <div style="flex: 1; border: 1px solid var(--gray-200); border-radius: var(--border-radius); overflow: hidden; display: flex; flex-direction: column;">
                            <div style="background: var(--gray-50); padding: 0.75rem; border-bottom: 1px solid var(--gray-200); font-weight: 600;">
                                <i class="fas fa-shopping-cart"></i> Productos en la Factura
                                <span id="itemCount" style="float: right; font-weight: normal; color: var(--gray-600);">0 productos</span>
                            </div>
                            <div id="invoiceProducts" style="flex: 1; overflow-y: auto; min-height: 200px;">
                                <div style="padding: 2rem; text-align: center; color: var(--gray-500);">
                                    <i class="fas fa-shopping-cart" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                    <p>No hay productos agregados</p>
                                    <p style="font-size: 0.875rem;">Busque productos para agregarlos</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Acciones rápidas -->
                        <div class="quick-actions" style="margin: 1rem 0;">
                            <button class="btn btn-secondary btn-sm" onclick="clearInvoice()">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="applyDiscount()">
                                <i class="fas fa-percent"></i> Descuento
                            </button>
                        </div>
                        
                        <!-- Totales y método de pago -->
                        <div class="invoice-summary">
                            <div class="summary-line">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotal">Q0.00</span>
                            </div>
                            <div class="summary-line">
                                <span>Descuento:</span>
                                <span id="invoiceDiscount">Q0.00</span>
                            </div>
                            <div class="summary-line">
                                <span>IVA (12%):</span>
                                <span id="invoiceTax">Q0.00</span>
                            </div>
                            <div class="summary-line total">
                                <span>Total:</span>
                                <span id="invoiceTotal">Q0.00</span>
                            </div>
                        </div>
                        
                        <div class="payment-details">
                            <label class="form-label">Método de Pago</label>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <button class="btn btn-secondary payment-method active" data-method="efectivo">
                                    <i class="fas fa-money-bill-wave"></i> Efectivo
                                </button>
                                <button class="btn btn-secondary payment-method" data-method="tarjeta">
                                    <i class="fas fa-credit-card"></i> Tarjeta
                                </button>
                                <button class="btn btn-secondary payment-method" data-method="cheque">
                                    <i class="fas fa-money-check"></i> Cheque
                                </button>
                            </div>
                            
                            <div id="paymentDetailsSection">
                                <div class="form-group">
                                    <label class="form-label">Monto Recibido</label>
                                    <input type="number" class="form-input" id="cashAmount" 
                                           placeholder="0.00" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Vuelto</label>
                                    <input type="number" class="form-input" id="changeAmount" 
                                           readonly style="background: var(--gray-100);">
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" 
                                onclick="processInvoice()" disabled id="processBtn">
                            <i class="fas fa-cash-register"></i>
                            Procesar Venta
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de éxito -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h3 style="color: var(--success-green); margin-bottom: 0.5rem;">¡Venta Procesada!</h3>
            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Factura generada exitosamente</p>
            <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                <div style="font-weight: 600;">Factura: <span id="invoiceNumber"></span></div>
                <div style="color: var(--gray-600);">Total: <span id="invoiceTotalModal"></span></div>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                <button class="btn btn-secondary" onclick="printInvoice()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button class="btn btn-primary" onclick="closeSuccessModal()">
                    <i class="fas fa-check"></i> Continuar
                </button>
            </div>
        </div>
    </div>

    <script src="/frontend/assets/js/config.js"></script>
    <script src="/frontend/assets/js/auth.js"></script>
    <script src="/frontend/assets/js/api.js"></script>
    <script src="/frontend/assets/js/utils.js"></script>
    <script src="/frontend/assets/js/components.js"></script>
    
    <script>
        // Verificar autenticación y permisos
        if (!auth.isAuthenticated()) {
            window.location.href = '/frontend/pages/public/login.html';
        }

        if (!auth.hasPermission([CONFIG.ROLES.ADMIN, CONFIG.ROLES.CAJERO, CONFIG.ROLES.DIGITADOR])) {
            Utils.showToast('No tienes permisos para acceder al punto de venta', 'error');
            window.location.href = '/frontend/pages/admin/dashboard.html';
        }

        // Variables globales
        let invoiceItems = [];
        let selectedPaymentMethod = 'efectivo';
        let currentCategory = 'all';
        let discountAmount = 0;

        // Cargar datos del usuario
        function loadUserData() {
            document.getElementById('userAvatar').textContent = auth.getUserInitials();
            document.getElementById('userName').textContent = auth.user.nombre_completo;
            document.getElementById('userRole').textContent = auth.user.rol;
            document.getElementById('sidebarRole').textContent = auth.user.rol;
            document.getElementById('sidebarEmail').textContent = auth.user.email;
            document.getElementById('cashierName').textContent = auth.user.nombre_completo;
        }

        // Cargar menú según rol
        function loadSidebarMenu() {
            const menuItems = [];
            
            // Dashboard - siempre visible
            menuItems.push({
                icon: 'fas fa-home',
                label: 'Dashboard',
                href: '/frontend/pages/admin/dashboard.html',
                active: false
            });

            // Gestión de Productos - Admin y Digitador
            if (auth.hasPermission([CONFIG.ROLES.ADMIN, CONFIG.ROLES.DIGITADOR])) {
                menuItems.push({
                    icon: 'fas fa-box',
                    label: 'Productos',
                    href: '/frontend/pages/productos/productos.html',
                    active: false
                });

                menuItems.push({
                    icon: 'fas fa-tags',
                    label: 'Categorías',
                    href: '/frontend/pages/productos/categorias.html',
                    active: false
                });
            }

            // Inventario - todos los roles
            if (auth.hasPermission([CONFIG.ROLES.ADMIN, CONFIG.ROLES.DIGITADOR, CONFIG.ROLES.CAJERO, CONFIG.ROLES.GERENTE])) {
                menuItems.push({
                    icon: 'fas fa-boxes',
                    label: 'Inventario',
                    href: '/frontend/pages/productos/inventario.html',
                    active: false
                });
            }

            // Ventas - Cajero, Digitador, Admin
            if (auth.hasPermission([CONFIG.ROLES.ADMIN, CONFIG.ROLES.DIGITADOR, CONFIG.ROLES.CAJERO])) {
                menuItems.push({
                    icon: 'fas fa-cash-register',
                    label: 'Punto de Venta',
                    href: '/frontend/pages/ventas/pos.html',
                    active: true
                });
            }

            // Reportes - Gerente, Admin
            if (auth.hasPermission([CONFIG.ROLES.ADMIN, CONFIG.ROLES.GERENTE])) {
                menuItems.push({
                    icon: 'fas fa-chart-bar',
                    label: 'Reportes',
                    href: '/frontend/pages/reportes/reportes.html',
                    active: false
                });
            }

            // Gestión de Usuarios - Solo Admin
            if (auth.hasPermission([CONFIG.ROLES.ADMIN])) {
                menuItems.push({
                    icon: 'fas fa-users',
                    label: 'Usuarios',
                    href: '/frontend/pages/admin/usuarios.html',
                    active: false
                });
            }

            const menuHTML = menuItems.map(item => `
                <li>
                    <a href="${item.href}" class="${item.active ? 'active' : ''}">
                        <i class="${item.icon}"></i>
                        ${item.label}
                    </a>
                </li>
            `).join('');

            document.getElementById('sidebarNav').innerHTML = menuHTML;
        }

        // Buscar productos
        async function searchProducts(query) {
            if (!query || query.length < 2) {
                document.getElementById('productSearchResults').innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--gray-500);">
                        <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>Escriba al menos 2 caracteres para buscar</p>
                    </div>
                `;
                return;
            }

            try {
                const params = { buscar: query, limit: 20 };
                if (currentCategory !== 'all') {
                    params.categoria = currentCategory;
                }

                const response = await api.getProductos(params);
                
                if (response.success && response.data.length > 0) {
                    const resultsHTML = response.data.map(product => {
                        const stock = product.stock || 0;
                        const stockClass = stock > 10 ? '' : stock > 0 ? 'low' : 'out';
                        const stockText = stock > 0 ? `Stock: ${stock}` : 'Sin stock';
                        
                        return `
                            <div class="product-search-item" onclick="addToInvoice(${product.id}, '${product.nombre.replace(/'/g, "\\'")}', ${product.precio_base}, ${stock})"
                                 ${stock === 0 ? 'style="opacity: 0.6; cursor: not-allowed;"' : ''}>
                                <div class="product-info">
                                    <div class="product-name">${product.nombre}</div>
                                    <div class="product-details">
                                        ${product.marca || 'Sin marca'} • ${product.categoria || 'Sin categoría'}
                                    </div>
                                    <div class="product-stock ${stockClass}">${stockText}</div>
                                </div>
                                <div class="product-price-section">
                                    <div class="product-price">
                                        ${Utils.formatCurrency(product.precio_base)}
                                    </div>
                                    <button class="btn btn-sm btn-primary" ${stock === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('productSearchResults').innerHTML = resultsHTML;
                } else {
                    document.getElementById('productSearchResults').innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--gray-500);">
                            <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p>No se encontraron productos para "${query}"</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error searching products:', error);
                document.getElementById('productSearchResults').innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--error-red);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Error buscando productos</p>
                    </div>
                `;
            }
        }

        // Filtrar productos por categoría
        function filterProducts(category) {
            currentCategory = category;
            
            // Actualizar botones de filtro
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // Realizar búsqueda si hay texto
            const query = document.getElementById('productSearchInput').value;
            if (query && query.length >= 2) {
                searchProducts(query);
            }
        }

        // Escanear código de barras
        function scanBarcode() {
            // En un entorno real, aquí se activaría la cámara o escáner
            Utils.showToast('Función de escáner de códigos de barras en desarrollo', 'info');
        }

        // Agregar producto a la factura
        function addToInvoice(productId, productName, price, stock) {
            if (stock === 0) {
                Utils.showToast('Producto sin stock disponible', 'error');
                return;
            }

            const existingItem = invoiceItems.find(item => item.productId === productId);
            
            if (existingItem) {
                if (existingItem.quantity < stock) {
                    existingItem.quantity += 1;
                    Utils.showToast(`Cantidad actualizada: ${productName}`, 'success');
                } else {
                    Utils.showToast('No hay más stock disponible', 'error');
                    return;
                }
            } else {
                invoiceItems.push({
                    productId: productId,
                    name: productName,
                    price: price,
                    quantity: 1,
                    maxStock: stock
                });
                Utils.showToast(`${productName} agregado a la factura`, 'success');
            }
            
            updateInvoiceDisplay();
        }

        // Actualizar cantidad de producto
        function updateQuantity(productId, newQuantity) {
            const item = invoiceItems.find(item => item.productId === productId);
            if (item) {
                if (newQuantity > 0 && newQuantity <= item.maxStock) {
                    item.quantity = newQuantity;
                    updateInvoiceDisplay();
                } else if (newQuantity > item.maxStock) {
                    Utils.showToast('Cantidad excede el stock disponible', 'error');
                } else {
                    removeFromInvoice(productId);
                }
            }
        }

        // Remover producto de la factura
        function removeFromInvoice(productId) {
            invoiceItems = invoiceItems.filter(item => item.productId !== productId);
            updateInvoiceDisplay();
        }

        // Limpiar factura
        function clearInvoice() {
            if (invoiceItems.length > 0 && confirm('¿Está seguro de limpiar toda la factura?')) {
                invoiceItems = [];
                discountAmount = 0;
                updateInvoiceDisplay();
                Utils.showToast('Factura limpiada', 'info');
            }
        }

        // Aplicar descuento
        function applyDiscount() {
            const subtotal = invoiceItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (subtotal === 0) {
                Utils.showToast('No hay productos para aplicar descuento', 'warning');
                return;
            }

            const discount = prompt('Ingrese el porcentaje de descuento (0-100):', '0');
            if (discount !== null) {
                const discountPercent = parseFloat(discount);
                if (!isNaN(discountPercent) && discountPercent >= 0 && discountPercent <= 100) {
                    discountAmount = subtotal * (discountPercent / 100);
                    updateInvoiceDisplay();
                    Utils.showToast(`Descuento del ${discountPercent}% aplicado`, 'success');
                } else {
                    Utils.showToast('Porcentaje de descuento inválido', 'error');
                }
            }
        }

        // Actualizar visualización de la factura
        function updateInvoiceDisplay() {
            const container = document.getElementById('invoiceProducts');
            const itemCount = document.getElementById('itemCount');
            
            if (invoiceItems.length === 0) {
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--gray-500);">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>No hay productos agregados</p>
                        <p style="font-size: 0.875rem;">Busque productos para agregarlos</p>
                    </div>
                `;
                itemCount.textContent = '0 productos';
            } else {
                const itemsHTML = invoiceItems.map(item => `
                    <div class="invoice-product-item">
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${item.name}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">
                                ${Utils.formatCurrency(item.price)} c/u • Stock: ${item.maxStock}
                            </div>
                        </div>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.quantity - 1})"
                                    ${item.quantity <= 1 ? 'style="opacity: 0.5;"' : ''}>-</button>
                            <input type="number" value="${item.quantity}" class="quantity-input" 
                                   onchange="updateQuantity(${item.productId}, parseInt(this.value))" 
                                   min="1" max="${item.maxStock}">
                            <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.quantity + 1})"
                                    ${item.quantity >= item.maxStock ? 'style="opacity: 0.5;"' : ''}>+</button>
                            <button class="btn btn-sm btn-danger" onclick="removeFromInvoice(${item.productId})" 
                                    style="margin-left: 0.5rem;" title="Eliminar producto">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = itemsHTML;
                itemCount.textContent = `${invoiceItems.length} producto${invoiceItems.length !== 1 ? 's' : ''}`;
            }
            
            updateTotals();
        }

        // Actualizar totales
        function updateTotals() {
            const subtotal = invoiceItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const afterDiscount = subtotal - discountAmount;
            const tax = afterDiscount * 0.12; // IVA 12%
            const total = afterDiscount + tax;
            
            document.getElementById('invoiceSubtotal').textContent = Utils.formatCurrency(subtotal);
            document.getElementById('invoiceDiscount').textContent = Utils.formatCurrency(discountAmount);
            document.getElementById('invoiceTax').textContent = Utils.formatCurrency(tax);
            document.getElementById('invoiceTotal').textContent = Utils.formatCurrency(total);
            
            // Habilitar/deshabilitar botón de procesar
            document.getElementById('processBtn').disabled = invoiceItems.length === 0;
            
            // Actualizar campos de pago
            if (selectedPaymentMethod === 'efectivo') {
                calculateChange();
            }
        }

        // Configurar métodos de pago
        function setupPaymentMethods() {
            const paymentButtons = document.querySelectorAll('.payment-method');
            
            paymentButtons.forEach(button => {
                button.addEventListener('click', () => {
                    paymentButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    selectedPaymentMethod = button.dataset.method;
                    updatePaymentDetails();
                });
            });
        }

        // Actualizar detalles de pago
        function updatePaymentDetails() {
            const section = document.getElementById('paymentDetailsSection');
            const total = parseFloat(document.getElementById('invoiceTotal').textContent.replace('Q', '').replace(',', ''));
            
            if (selectedPaymentMethod === 'efectivo') {
                section.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Monto Recibido</label>
                        <input type="number" class="form-input" id="cashAmount" 
                               placeholder="0.00" step="0.01" oninput="calculateChange()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vuelto</label>
                        <input type="number" class="form-input" id="changeAmount" 
                               readonly style="background: var(--gray-100);">
                    </div>
                `;
            } else if (selectedPaymentMethod === 'tarjeta') {
                section.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Número de Tarjeta</label>
                        <input type="text" class="form-input" id="cardNumber" 
                               placeholder="**** **** **** ****" maxlength="19">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monto</label>
                        <input type="number" class="form-input" id="cardAmount" 
                               value="${total.toFixed(2)}" readonly style="background: var(--gray-100);">
                    </div>
                `;
            } else { // cheque
                section.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Número de Cheque</label>
                        <input type="text" class="form-input" id="checkNumber" 
                               placeholder="Número de cheque">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Banco</label>
                        <input type="text" class="form-input" id="bankName" 
                               placeholder="Banco emisor">
                    </div>
                `;
            }
        }

        // Calcular vuelto
        function calculateChange() {
            const cashAmountElement = document.getElementById('cashAmount');
            const changeAmountElement = document.getElementById('changeAmount');
            
            if (cashAmountElement && changeAmountElement) {
                const cashAmount = parseFloat(cashAmountElement.value) || 0;
                const total = parseFloat(document.getElementById('invoiceTotal').textContent.replace('Q', '').replace(',', ''));
                const change = Math.max(0, cashAmount - total);
                
                changeAmountElement.value = change.toFixed(2);
            }
        }

        // Procesar venta
        async function processInvoice() {
            if (invoiceItems.length === 0) {
                Utils.showToast('No hay productos en la factura', 'error');
                return;
            }

            try {
                const total = parseFloat(document.getElementById('invoiceTotal').textContent.replace('Q', '').replace(',', ''));
                
                // Validar método de pago
                if (selectedPaymentMethod === 'efectivo') {
                    const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
                    if (cashAmount < total) {
                        Utils.showToast('El monto recibido es menor al total', 'error');
                        return;
                    }
                } else if (selectedPaymentMethod === 'tarjeta') {
                    const cardNumber = document.getElementById('cardNumber').value.trim();
                    if (!cardNumber) {
                        Utils.showToast('Ingrese el número de tarjeta', 'error');
                        return;
                    }
                } else if (selectedPaymentMethod === 'cheque') {
                    const checkNumber = document.getElementById('checkNumber').value.trim();
                    const bankName = document.getElementById('bankName').value.trim();
                    if (!checkNumber || !bankName) {
                        Utils.showToast('Complete la información del cheque', 'error');
                        return;
                    }
                }

                // Preparar datos de la factura
                const facturaData = {
                    serie: 'A',
                    correlativo: parseInt(document.getElementById('nextCorrelativo').textContent),
                    fecha_emision: new Date().toISOString(),
                    consumidor_final: document.getElementById('consumidorFinal').checked,
                    cliente_nit: document.getElementById('clientNit').value || null,
                    cliente_nombre: document.getElementById('clientName').value || 'Consumidor Final',
                    cliente_direccion: document.getElementById('clientAddress').value || null,
                    sucursal_id: 1,
                    empleado_id: auth.user.id,
                    descuento_total: discountAmount,
                    productos: invoiceItems.map(item => ({
                        producto_id: item.productId,
                        cantidad: item.quantity,
                        precio_unitario: item.price,
                        descuento: 0
                    })),
                    metodos_pago: [{
                        tipo_pago_id: selectedPaymentMethod === 'efectivo' ? 1 : selectedPaymentMethod === 'tarjeta' ? 3 : 2,
                        monto: total
                    }]
                };

                Utils.showToast('Procesando venta...', 'info');
                
                // Simular API call (reemplazar con llamada real)
                // const response = await api.createFactura(facturaData);
                
                // Simulación de éxito
                setTimeout(() => {
                    const invoiceNumber = `A-${document.getElementById('nextCorrelativo').textContent}`;
                    showSuccessModal(invoiceNumber, total);
                    
                    // Limpiar factura
                    invoiceItems = [];
                    discountAmount = 0;
                    updateInvoiceDisplay();
                    
                    // Incrementar correlativo
                    const nextNum = parseInt(document.getElementById('nextCorrelativo').textContent) + 1;
                    document.getElementById('nextCorrelativo').textContent = nextNum.toString().padStart(3, '0');
                    
                    // Limpiar campos de cliente
                    document.getElementById('consumidorFinal').checked = true;
                    document.getElementById('clientDataSection').classList.add('hidden');
                    
                    // Resetear método de pago
                    updatePaymentDetails();
                    
                }, 1500);
                
            } catch (error) {
                console.error('Error processing invoice:', error);
                Utils.showToast('Error procesando la venta', 'error');
            }
        }

        // Mostrar modal de éxito
        function showSuccessModal(invoiceNumber, total) {
            document.getElementById('invoiceNumber').textContent = invoiceNumber;
            document.getElementById('invoiceTotalModal').textContent = Utils.formatCurrency(total);
            document.getElementById('successModal').style.display = 'flex';
        }

        // Cerrar modal de éxito
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        // Imprimir factura
        function printInvoice() {
            Utils.showToast('Imprimiendo factura...', 'info');
            // Aquí se implementaría la lógica de impresión
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Búsqueda de productos
            const searchInput = document.getElementById('productSearchInput');
            searchInput.addEventListener('input', Utils.debounce((e) => {
                searchProducts(e.target.value);
            }, 300));

            // Checkbox consumidor final
            document.getElementById('consumidorFinal').addEventListener('change', (e) => {
                const clientSection = document.getElementById('clientDataSection');
                if (e.target.checked) {
                    clientSection.classList.add('hidden');
                } else {
                    clientSection.classList.remove('hidden');
                }
            });

            // Teclas de acceso rápido
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'f':
                        case 'F':
                            e.preventDefault();
                            document.getElementById('productSearchInput').focus();
                            break;
                        case 'n':
                        case 'N':
                            e.preventDefault();
                            clearInvoice();
                            break;
                        case 'Enter':
                            if (invoiceItems.length > 0) {
                                e.preventDefault();
                                processInvoice();
                            }
                            break;
                    }
                }
            });
        }

        // Hacer funciones disponibles globalmente
        window.addToInvoice = addToInvoice;
        window.updateQuantity = updateQuantity;
        window.removeFromInvoice = removeFromInvoice;
        window.clearInvoice = clearInvoice;
        window.applyDiscount = applyDiscount;
        window.filterProducts = filterProducts;
        window.scanBarcode = scanBarcode;
        window.calculateChange = calculateChange;
        window.processInvoice = processInvoice;
        window.closeSuccessModal = closeSuccessModal;
        window.printInvoice = printInvoice;

        // Inicializar página
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            loadSidebarMenu();
            setupEventListeners();
            setupPaymentMethods();
            updatePaymentDetails();
        });
    </script>
</body>
</html>